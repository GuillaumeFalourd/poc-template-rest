# BUILD

variables:
  VERSION: ${CI_COMMIT_REF_NAME}
  DOCKERFILE: "Dockerfile"
  DOCKER_BUILD_ARGS: ""

.docker_build:
  image: itau-docker-base.depdes.artifactory.prod.cloud.ihf/docker:cli
  services:
    - alias: docker
      name: itau-docker-base.depdes.artifactory.prod.cloud.ihf/docker:dind
      command: ["--insecure-registry=itau-docker-base.depdes.artifactory.prod.cloud.ihf","--insecure-registry=itau-docker-golden.depdes.artifactory.prod.cloud.ihf"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  stage: build
  script:
    - docker build -t $CI_PROJECT_NAME:$VERSION -f $DOCKERFILE $DOCKER_BUILD_ARGS --build-arg VERSION=$VERSION .
    - docker save -o $CI_PROJECT_NAME-$VERSION.tar $CI_PROJECT_NAME:$VERSION
  artifacts:
    paths:
      - $CI_PROJECT_NAME-$VERSION.tar
  only:
    - branches
    - tags
  tags:
    - ci

# Example Usage:

  # build_1.0.0:
  #   extends: .docker_build
  #   variables:
  #     VERSION: 1.0.0
  #     DOCKERFILE: Dockerfile.custom
  #     DOCKER_BUILD_ARGS: "--build-arg ARG1=A --build-arg ARG2=B"
