stages:
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true -Dsurefire.useSystemClassLoader=false -Djdk.net.URLClassPath.disableClassPathURLCheck=true"
  MAVEN_VERSION: "3.6.3-jdk11"
  MAVEN_TEST_PARAMETERS: "-s settings.xml"

unit_test:
  image: itau-docker-base.depdes.artifactory.prod.cloud.ihf/maven:$MAVEN_VERSION
  stage: test
  script:
   - mvn $MAVEN_CLI_OPTS test $MAVEN_TEST_PARAMETERS
   - mvn $MAVEN_CLI_OPTS jacoco:report surefire-report:report-only $MAVEN_TEST_PARAMETERS
   # Pega Coverage
   - if test -f target/site/jacoco/jacoco.csv; then awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, "instructions covered"; print "Total:", int(100*covered/instructions) "% covered" }' target/site/jacoco/jacoco.csv; fi
   - if test -f app/target/site/jacoco/jacoco.csv; then awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, "instructions covered"; print "Total:", int(100*covered/instructions) "% covered" }' app/target/site/jacoco/jacoco.csv; fi
  coverage: '/Total.*?([0-9]{1,3})%/'
  allow_failure: false
  artifacts:
    expire_in: 1 day
    paths:
      - ./target/jacoco.exec
      - ./target/site
      - ./app/target/jacoco.exec
      - ./app/target/site
  except:
    variables:
      - $DISABLE_TEST
  tags:
    - ci
