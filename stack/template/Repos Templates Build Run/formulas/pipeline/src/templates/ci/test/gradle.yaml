stages:
    - test
  
variables:
  GRADLE_VERSION: "jdk11"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradlehome"
  
unit_test:
  image: itau-docker-base.depdes.artifactory.prod.cloud.ihf/gradle:$GRADLE_VERSION
  stage: test
  script:
    - ./gradlew test --info
    # Pega Coverage
    - if test -f build/reports/jacoco/test/jacocoTestReport.csv; then awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, "instructions covered"; print "Total:", int(100*covered/instructions) "% covered" }' build/reports/jacoco/test/jacocoTestReport.csv; fi
  coverage: '/Total.*?([0-9]{1,3})%/'
  tags:
    - ci
  allow_failure: false
  artifacts:
    expire_in: 1 day
    paths:
      - ./build
      - gradle.properties
  cache:
    key: build
    paths:
      - build
      - .gradle
      - .gradlehome/wrapper
      - .gradlehome/caches/modules*
    policy: pull
  except:
    variables:
      - $DISABLE_TEST
